<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Foto 3x4 Smart Parser - MTD26</title>
    <style>
        :root {
            --photo-w: 30mm;
            --photo-h: 40mm;
            --page-margin: 3mm;
            --cut-color: #999; 
        }

        body {
            background: #333; font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- PANEL KONTROL --- */
        .no-print {
            background: white; padding: 15px 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: sticky; top: 10px; z-index: 999;
            display: flex; gap: 20px; flex-wrap: wrap; align-items: center; justify-content: center;
            border-bottom: 4px solid #00acc1; margin-bottom: 20px;
        }
        
        .ctrl-section {
            display: flex; flex-direction: column; gap: 5px;
            border: 1px solid #eee; padding: 10px; border-radius: 6px; background: #f9f9f9;
        }
        .ctrl-label { font-size: 11px; font-weight: bold; color: #00acc1; text-transform: uppercase; margin-bottom: 2px; }
        
        input[type=text] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 300px; font-weight: bold; font-family: monospace; }
        input[type=number] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 60px; text-align: center; font-weight: bold; }
        
        button {
            padding: 10px 20px; background: #00acc1; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        button:hover { background: #00838f; transform: translateY(-1px); }
        .btn-print { background: #1a237e; }
        
        #statusMsg { font-size: 12px; font-weight: bold; color: #d35400; margin-top: 5px; text-align: center; }

        /* --- HALAMAN A4 --- */
        @page { size: A4 portrait; margin: var(--page-margin); }
        .sheet {
            background: white; width: 210mm; height: 297mm; padding: var(--page-margin);
            box-sizing: border-box; margin-bottom: 20px; display: flex; flex-wrap: wrap;
            align-content: flex-start; page-break-after: always; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .slot {
            width: var(--photo-w); height: var(--photo-h); box-sizing: border-box;
            position: relative; display: flex; justify-content: center; align-items: center;
            font-size: 10px; color: #eee; user-select: none;
        }

        .slot.has-photo { box-shadow: 0 0 0 0.5px var(--cut-color); color: transparent; }

        .photo-img { width: calc(100% - 2mm); height: calc(100% - 2mm); object-fit: cover; }
        .name-label {
            position: absolute; bottom: 2mm; width: 100%; text-align: center; font-size: 7px;
            color: #000; background: rgba(255,255,255,0.8); white-space: nowrap; overflow: hidden;
        }
        .data-idx { position: absolute; top: 1px; left: 2px; font-size: 8px; color: #555; background: rgba(255,255,255,0.8); padding: 0 2px; border-radius: 2px; }

        @media print {
            body { background: none; padding: 0; }
            .no-print { display: none !important; }
            .sheet { margin: 0; box-shadow: none; }
            .slot:not(.has-photo) { color: transparent !important; }
            .name-label, .data-idx { display: none; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <div style="text-align:center;">
            <button onclick="fetchData()">üîÑ LOAD DATA</button>
            <div id="statusMsg">Klik Load Data</div>
        </div>
        
        <div class="ctrl-section">
            <span class="ctrl-label">Daftar Nomor yang Dicetak</span>
            <input type="text" id="smartInput" placeholder="Contoh: 1-5, 8, 10-12, 50, 50">
            <small style="color:#888; font-size:10px;">Gunakan koma (,) dan strip (-) untuk rentang.</small>
        </div>

        <div class="ctrl-section">
            <span class="ctrl-label">Mulai di Kotak Kertas</span>
            <input type="number" id="offsetPos" value="1" min="1" max="42">
        </div>

        <button onclick="renderPhotos()">TERAPKAN</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è CETAK</button>
    </div>

    <div id="outputArea"></div>

<script>
    const SHEET_ID = '1qckWYXGTqhKMM-WRpzoBwURwXUUrpXo0aBJ_MVi9tQg'; 
    const SHEET_NAME = 'Daftar'; 
    const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    let globalData = [];

    function fetchData() {
        const msg = document.getElementById('statusMsg');
        msg.innerText = "‚è≥..";
        fetch(DATA_URL).then(res => res.text()).then(text => {
            const jsonText = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/)[1];
            const json = JSON.parse(jsonText);
            parseData(json);
            msg.innerText = `‚úÖ Terbaca: ${globalData.length} data`;
            renderPhotos();
        }).catch(e => { msg.innerText = "‚ùå Gagal Load"; });
    }

    function parseData(json) {
        const rows = json.table.rows;
        const IDX_NAMA = 2;
        const IDX_FOTO = 34;
        globalData = rows.map((r, i) => {
            const c = r.c;
            if(!c) return null;
            let nama = c[IDX_NAMA] ? (c[IDX_NAMA].v || "Tanpa Nama") : "Tanpa Nama";
            let link = "";
            if(c[IDX_FOTO]) link = c[IDX_FOTO].v || "";
            if(!link || link.length < 5) {
                for(let k=0; k<c.length; k++) {
                    let v = c[k] ? String(c[k].v) : "";
                    if(v.includes("drive.google.com") || v.includes("data:image")) { link = v; break; }
                }
            }
            return { index: i + 1, nama: nama, foto: link };
        }).filter(d => d);
    }

    // --- SMART PARSER ENGINE ---
    function parseSmartInput(input) {
        let queue = [];
        if(!input) return queue;

        // Pisahkan berdasarkan koma
        let parts = input.split(',');
        
        parts.forEach(part => {
            part = part.trim();
            if(part.includes('-')) {
                // Proses Rentang (1-10)
                let range = part.split('-');
                let start = parseInt(range[0]);
                let end = parseInt(range[1]);
                if(!isNaN(start) && !isNaN(end)) {
                    // Pastikan arah loop benar (1-3 atau 3-1)
                    if(start <= end) {
                        for(let i = start; i <= end; i++) queue.push(i);
                    } else {
                        for(let i = start; i >= end; i--) queue.push(i);
                    }
                }
            } else {
                // Proses Angka Tunggal
                let num = parseInt(part);
                if(!isNaN(num)) queue.push(num);
            }
        });
        return queue;
    }

    function renderPhotos() {
        const container = document.getElementById('outputArea');
        container.innerHTML = "";
        if(globalData.length === 0) return;

        // Jalankan Parser
        const inputVal = document.getElementById('smartInput').value;
        const indices = parseSmartInput(inputVal);
        
        // Ambil Data Berdasarkan Hasil Parser
        const dataQueue = indices.map(idx => {
            return globalData[idx - 1] ? globalData[idx - 1] : { index: idx, nama: "Tidak Ada", foto: "" };
        });

        if(dataQueue.length === 0 && inputVal.length > 0) return;

        const paperOffset = Math.max(1, parseInt(document.getElementById('offsetPos').value));
        const SLOTS_PER_PAGE = 42; 
        const totalSlotsNeeded = (paperOffset - 1) + (dataQueue.length || 0);
        const totalSheets = Math.ceil(totalSlotsNeeded / SLOTS_PER_PAGE) || 1;

        let currentDataIdx = 0;

        for(let s = 0; s < totalSheets; s++) {
            const sheet = document.createElement('div');
            sheet.className = 'sheet';

            for(let i = 1; i <= SLOTS_PER_PAGE; i++) {
                const globalSlotIndex = (s * SLOTS_PER_PAGE) + i;
                const div = document.createElement('div');
                div.className = 'slot';
                
                if (globalSlotIndex < paperOffset) {
                    div.innerText = globalSlotIndex; 
                } else if (currentDataIdx < dataQueue.length) {
                    const item = dataQueue[currentDataIdx];
                    div.classList.add('has-photo');
                    
                    let src = item.foto;
                    if(src && src.includes('drive.google.com')) {
                        const m = src.match(/[-\w]{25,}/);
                        if(m) src = "https://drive.google.com/thumbnail?id=" + m[0] + "&sz=w500";
                    }

                    if(src && src.length > 10) {
                        div.innerHTML = `<img src="${src}" class="photo-img" onerror="this.style.display='none'"><div class="name-label">${item.nama.substring(0,12)}</div><div class="data-idx">#${item.index}</div>`;
                    } else {
                        div.innerHTML = `<div style="font-size:9px; color:black; text-align:center;">${item.nama.substring(0,10)}<br>(No Foto)</div><div class="data-idx">#${item.index}</div>`;
                    }
                    currentDataIdx++;
                } else {
                    div.innerText = globalSlotIndex;
                }
                sheet.appendChild(div);
            }
            container.appendChild(sheet);
        }
    }
    
    window.onload = fetchData;
</script>
</body>
</html>
