<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Foto 3x4 Smart Offset - MTD26</title>
    <style>
        :root {
            /* KONFIGURASI UKURAN */
            --photo-w: 30mm;
            --photo-h: 40mm;
            --page-margin: 3mm;
            --cut-color: #999; 
        }

        body {
            background: #333; font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- PANEL KONTROL --- */
        .no-print {
            background: white; padding: 15px 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: sticky; top: 10px; z-index: 999;
            display: flex; gap: 15px; flex-wrap: wrap; align-items: center; justify-content: center;
            border-bottom: 4px solid #00acc1; margin-bottom: 20px;
        }
        .ctrl-group { display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: bold; color: #555; }
        input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        button {
            padding: 8px 15px; background: #00acc1; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        button:hover { background: #00838f; }
        .btn-print { background: #1a237e; }
        #statusMsg { font-size: 12px; font-weight: bold; color: #d35400; margin-left: 5px; }

        /* --- HALAMAN A4 --- */
        @page {
            size: A4 portrait;
            margin: var(--page-margin);
        }

        .sheet {
            background: white;
            width: 210mm; height: 297mm;
            padding: var(--page-margin);
            box-sizing: border-box;
            margin-bottom: 20px;
            display: flex; flex-wrap: wrap; align-content: flex-start;
            page-break-after: always;
            /* Debugging Shadow di layar */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* --- SLOT GRID (KOTAK 3x4) --- */
        .slot {
            width: var(--photo-w);
            height: var(--photo-h);
            box-sizing: border-box;
            position: relative;
            display: flex; justify-content: center; align-items: center;
            font-size: 10px; color: #eee; /* Warna nomor grid samar */
            user-select: none;
        }

        /* --- FOTO AKTIF --- */
        .slot.has-photo {
            /* Garis Potong Pintar: 
               Menggunakan box-shadow inset 0.5px. 
               Jika dua foto bersebelahan, 0.5px + 0.5px = 1px garis solid.
               Tidak menggunakan border agar ukuran box tidak berantakan.
            */
            box-shadow: 0 0 0 0.5px var(--cut-color);
            color: transparent; /* Sembunyikan nomor grid */
        }

        .photo-img {
            /* Area Aman (Padding Putih 1mm) */
            /* Foto asli 28x38mm, visual jarak antar foto 2mm */
            width: calc(100% - 2mm);
            height: calc(100% - 2mm);
            object-fit: cover;
            /* Opsional: Border halus di sekeliling foto */
            /* outline: 1px solid #eee; */
        }

        /* Label Nama Kecil (Hilang saat print) */
        .name-label {
            position: absolute; bottom: 2mm; width: 100%;
            text-align: center; font-size: 7px; color: #000;
            background: rgba(255,255,255,0.8);
            white-space: nowrap; overflow: hidden;
        }

        /* PRINT MODE */
        @media print {
            body { background: none; padding: 0; }
            .no-print { display: none !important; }
            .sheet { margin: 0; box-shadow: none; }
            /* Nomor grid di kotak kosong tidak boleh tercetak */
            .slot:not(.has-photo) { color: transparent !important; }
            /* Label nama disembunyikan agar bersih */
            .name-label { display: none; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <div class="ctrl-group">
            <button onclick="fetchData()">üîÑ LOAD DATA</button>
            <span id="statusMsg">...</span>
        </div>
        
        <div style="border-left:1px solid #ccc; height:25px"></div>
        
        <div class="ctrl-group">
            <label>Mulai di Kotak No:</label>
            <input type="number" id="offsetPos" value="1" min="1" max="42" style="width:50px" title="Gunakan ini jika kertas bagian atas sudah terpakai">
        </div>
        
        <div class="ctrl-group">
            <label>Jml Foto:</label>
            <input type="number" id="printCount" value="42" style="width:50px">
        </div>

        <button onclick="renderPhotos()">TERAPKAN</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è CETAK</button>
    </div>

    <div id="outputArea"></div>

<script>
    // --- KONFIGURASI ---
    const SHEET_ID = '1qckWYXGTqhKMM-WRpzoBwURwXUUrpXo0aBJ_MVi9tQg'; 
    const SHEET_NAME = 'Daftar'; 
    const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    let globalData = [];

    function fetchData() {
        const msg = document.getElementById('statusMsg');
        msg.innerText = "‚è≥..";
        
        fetch(DATA_URL)
            .then(res => res.text())
            .then(text => {
                const jsonText = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/)[1];
                const json = JSON.parse(jsonText);
                parseData(json);
                msg.innerText = `‚úÖ ${globalData.length}`;
                renderPhotos();
            })
            .catch(e => {
                console.error(e);
                msg.innerText = "‚ùå Err";
            });
    }

    function parseData(json) {
        const rows = json.table.rows;
        // Index Kolom: Nama (2), Link Foto (34 / AI)
        const IDX_NAMA = 2;
        const IDX_FOTO = 34;

        globalData = rows.map(r => {
            const c = r.c;
            if(!c) return null;
            
            let nama = c[IDX_NAMA] ? (c[IDX_NAMA].v || "Tanpa Nama") : "Tanpa Nama";
            
            // Logika Pencarian Link Foto (Smart Fallback)
            let link = "";
            if(c[IDX_FOTO]) link = c[IDX_FOTO].v || "";
            // Jika kolom 34 kosong, cari kolom lain yg mengandung 'http'
            if(!link || link.length < 5) {
                for(let i=0; i<c.length; i++) {
                    let val = c[i] ? String(c[i].v) : "";
                    if(val.includes("drive.google.com") || val.includes("data:image")) {
                        link = val; break;
                    }
                }
            }

            return { nama: nama, foto: link };
        }).filter(d => d);
    }

    function renderPhotos() {
        const container = document.getElementById('outputArea');
        container.innerHTML = "";

        if(globalData.length === 0) return;

        // Parameter Kontrol
        const offset = Math.max(1, parseInt(document.getElementById('offsetPos').value)); // 1-based
        const count = parseInt(document.getElementById('printCount').value);
        
        // Data yang mau dicetak
        const dataQueue = globalData.slice(0, count); // Ambil sejumlah count dari data awal (atau bisa ditambah logika interval data)

        // Hitung Layout
        // A4 Margin 3mm -> Lebar area 204mm, Tinggi 291mm
        // Grid: 30mm x 40mm. 
        // Kapasitas: 6 Kolom x 7 Baris = 42 Slot
        const SLOTS_PER_PAGE = 42;
        
        // Total Slot yang dibutuhkan = Offset (kosong) + Data
        const totalSlotsNeeded = (offset - 1) + dataQueue.length;
        const totalSheets = Math.ceil(totalSlotsNeeded / SLOTS_PER_PAGE);

        let dataIndex = 0;

        for(let s = 0; s < totalSheets; s++) {
            const sheet = document.createElement('div');
            sheet.className = 'sheet';

            // Render 42 Slot per halaman
            for(let i = 1; i <= SLOTS_PER_PAGE; i++) {
                const globalSlotIndex = (s * SLOTS_PER_PAGE) + i;
                const div = document.createElement('div');
                div.className = 'slot';
                
                // LOGIKA ISI SLOT
                // 1. Apakah ini slot kosong (sebelum posisi mulai)?
                if (globalSlotIndex < offset) {
                    div.innerText = globalSlotIndex; // Tampilkan nomor grid (layar saja)
                } 
                // 2. Apakah masih ada data untuk dicetak?
                else if (dataIndex < dataQueue.length) {
                    const item = dataQueue[dataIndex];
                    div.classList.add('has-photo'); // Aktifkan garis potong
                    
                    let src = item.foto;
                    // Fix Thumbnail
                    if(src && src.includes('drive.google.com')) {
                        const m = src.match(/[-\w]{25,}/);
                        if(m) src = "https://drive.google.com/thumbnail?id=" + m[0] + "&sz=w500";
                    }

                    if(src && src.length > 10) {
                        div.innerHTML = `
                            <img src="${src}" class="photo-img" onerror="this.style.display='none'; this.parentElement.innerText='ERR'">
                            <div class="name-label">${item.nama.substring(0,10)}</div>
                        `;
                    } else {
                        div.innerHTML = `<div style="font-size:9px; color:black; text-align:center;">${item.nama.substring(0,10)}<br>(No Foto)</div>`;
                    }
                    
                    dataIndex++;
                } 
                // 3. Slot sisa setelah data habis
                else {
                    div.innerText = globalSlotIndex; // Tampilkan nomor grid
                }

                sheet.appendChild(div);
            }
            container.appendChild(sheet);
        }
    }
    
    // Init
    window.onload = fetchData;
</script>

</body>
</html>
